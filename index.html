<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <style type="text/css">
        .eruda-search-highlight-block {
            display: inline;
        }

        .eruda-search-highlight-block .eruda-keyword {
            background: #332a00;
            color: #ffcb6b;
        }
    </style>
    <script>
        // Initialize Eruda
        eruda.init();
    </script>
    <!-- Import map to include @google/generative-ai -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .response-container {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 600px;
        }

        .model-response {
            margin-bottom: 10px;
        }

        .preview-container {
            border: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: auto;
        }
    </style>
</head>

<body>
    <iframe id="preview" class="preview-container">
    </iframe>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEY = "AIzaSyB3lmQJddVZA9dvJrlXPJGyD-Mg-c6PH2Y";
        // List of API keys
        const API_KEYS = [
            "AIzaSyB3lmQJddVZA9dvJrlXPJGyD-Mg-c6PH2Y",
            "AIzaSyBSwB1zvULUmCO2CHS3fhrbo-LrUIs8tRg",
            "AIzaSyBkpR4uznS-GAtaATcCZkoDIGb8A7wIbOs",
            "AIzaSyBrMvWg8sX8KuHdatYOgBLXM4BrLqKgqUE"
        ];

        // Index to track the current API key
        let currentKeyIndex = 0;

        const genAI = new GoogleGenerativeAI(API_KEY);

        const mainModel = genAI.getGenerativeModel({
            model: "gemini-2.0-flash-exp",
            systemInstruction: `
                Generate a detailed and comprehensive series of instructions to modify or create an HTML page step-by-step. 
                Each instruction should be clear, precise, and logically ordered, covering all necessary details - but may include a variety of edits together. 

                **Key Guidelines:**
                - everything is in 1 already created html file. css in a style tag, js in a script tag.
                - Include specific CSS selectors (e.g., target specific elements like ".container" or "#main-header > button") for where edits will be applied, but not / or :contains for example.
                - Specify whether the action involves inserting, replacing, deleting, adding CSS, or adding JavaScript.
                - When including images, explicitly mention the source URL: https://quizizz-image-generation.blaub002-302.workers.dev/?prompt= + the image description.
                - The program executing your instructions can generate content to you can for example say make a span with a pretend description of a game for example etc...
                - Ensure the design follows modern web standards with professional aesthetics, comparable to websites created by companies like Microsoft or Google.
                - For any functionality requiring JavaScript:
                    - For js it will insert it into a script.
                    - Generate as much JavaScript as needed, even if it requires a large amount of code to achieve complex functionality.
                    - Ensure that complete functions, including all variable declarations, are added. Avoid leaving any incomplete code snippets.
                    - Always structure JavaScript code to be modular and well-commented for readability and maintainability.
                    - Include JavaScript in a way that ensures seamless integration and functionality.
                    - careful with js though, as it can only be added to the script tag - not edited, otherwise the program breaks

                **Examples of Clear Instructions:**
                - "Add a <div> with class 'main-content' and text 'Welcome to our website!' inside the <body> tag."
                - "create a style tag inside body"
                - "Insert CSS to style all buttons with a blue background, white text, and rounded corners. Target: <style> tag."
                - "Replace the existing image in #header with an image generated from: https://quizizz-image-generation.blaub002-302.workers.dev/?prompt=A futuristic cityscape at sunset."
                - "Add a <script> to implement a dynamic search functionality, with an input field, search button, and results container. Include all necessary functions and variables. Target: <body> tag."
                - "Insert JavaScript to create a carousel with next/previous buttons and infinite scrolling. Ensure all functionality is self-contained and modular."

                **Desired Standard:**
                - The final output should look and feel like a professionally designed website created by a top-tier company such as Microsoft or Google.
                - The visual style should be modern, clean, and user-friendly, with responsive design principles in mind.

                **Output Format:**
                - Provide all instructions in a single line, separated by commas, without extra explanations or formatting.
            `
        });


        const schema = {
            description: "Edit instruction for modifying HTML",
            type: "object",
            properties: {
                action: {
                    type: "string",
                    description: "Action to perform: replace, insert, or delete",
                    enum: ["replace", "insert", "delete"],
                },
                target: {
                    type: "string",
                    description: "CSS selector for the target element",
                },
                content: {
                    type: "string",
                    description: "HTML content for replace/insert",
                    nullable: true,
                    maxLength: 5000, // Limit content size
                    pattern: "^(?!.*<!DOCTYPE html>).*", // Disallow <!DOCTYPE html>
                },
            },
            required: ["action", "target"],
        };



        // Function to get the next API key
        function getNextApiKey() {
            const apiKey = API_KEYS[currentKeyIndex];
            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length; // Cycle through the keys
            return apiKey;
        }

        // Function to create a generative model with the next API key
        function createGenerativeModel() {
            const API_KEY = getNextApiKey(); // Get the next API key
            console.log(API_KEY)
            const genAI = new GoogleGenerativeAI(API_KEY); // Initialize GoogleGenerativeAI with the API key

            return genAI.getGenerativeModel({
                model: "gemini-1.5-flash",
                generationConfig: {
                    responseMimeType: "application/json", // Ensure JSON response
                    responseSchema: schema, // Use the predefined schema
                },
            });
        }

        const previewDiv = document.getElementById("preview");

        // Function to apply a single edit instruction to the HTML
        function applyEditInstruction(currentHTML, edit) {
            let parser = new DOMParser();
            let doc = parser.parseFromString(currentHTML, "text/html");

            switch (edit.action) {
                case 'replace':
                    const replaceElement = doc.querySelector(edit.target);
                    if (replaceElement) replaceElement.innerHTML = edit.content;
                    break;
                case 'insert':
                    if (edit.target == "") {
                      
                    } else {
                      const insertElement = doc.querySelector(edit.target);
                      if (insertElement) insertElement.innerHTML += edit.content;
                    }
                    break;
                case 'delete':
                    const deleteElement = doc.querySelector(edit.target);
                    if (deleteElement) deleteElement.remove();
                    break;
                default:
                    console.error(`Unknown action: ${edit.action}`);
            }

            return doc.documentElement.innerHTML;
        }

        // Function to dynamically process instruction via the secondary model
        async function processInstruction(currentHTML, instruction) {
            const response = await createGenerativeModel().generateContent(`HTML:${currentHTML}, Instruction:${instruction}`);
            var editInstruction = response.response.text();
            editInstruction = JSON.parse(editInstruction);
            console.log(`Instruction: ${instruction}, Edit:`, editInstruction);
            return applyEditInstruction(currentHTML, editInstruction);
        }

        // Main function to process AI instructions sequentially
        async function continuousConversation() {
            const response = await mainModel.generateContent("Generate a coding website");
            const instructions = response.response.text().split(',');
            let currentHTML = previewDiv.srcdoc;

            for (const instruction of instructions) {
                console.log(`Processing: ${instruction.trim()}`);
                currentHTML = await processInstruction(currentHTML, instruction.trim());
                previewDiv.srcdoc = currentHTML; // Update the preview div
                console.log(currentHTML)
            }

            console.log("All instructions processed.");
        }

        // Start the process
        continuousConversation();
    </script>
</body>

</html>